rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // =========================================================================
    // Helper Functions
    // =========================================================================
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(ownerUid) {
      return isSignedIn() && request.auth.uid == ownerUid;
    }

    function isCurrentUser() {
      return isSignedIn() && request.auth.uid == resource.data.uid;
    }

    function isCreatingOwned() {
      return isSignedIn() && request.resource.data.uid == request.auth.uid;
    }

    // Check parent conversation ownership for sub-collections
    function ownsParentConversation(conversationId) {
      return isSignedIn() && 
        get(/databases/$(database)/documents/conversations/$(conversationId)).data.uid == request.auth.uid;
    }

    // =========================================================================
    // Users Collection
    // =========================================================================
    
    match /users/{uid} {
      allow read, write: if isOwner(uid);
    }

    // =========================================================================
    // Conversations & Sub-collections
    // Sub-collections inherit access from parent conversation ownership.
    // No need for uid on each sub-document - we check the parent.
    // =========================================================================
    
    match /conversations/{conversationId} {
      allow create: if isCreatingOwned();
      allow read, update, delete: if isCurrentUser();

      // Messages inherit from conversation - no uid required on message docs
      match /messages/{messageId} {
        allow read, write: if ownsParentConversation(conversationId);
      }

      // Artifacts (reels, transcripts) - inherit from conversation
      match /artifacts/{artifactId} {
        allow read, write: if ownsParentConversation(conversationId);
      }

      // Unpacks (AI analysis) - inherit from conversation
      match /unpacks/{unpackId} {
        allow read, write: if ownsParentConversation(conversationId);
      }

      // Reply drafts - inherit from conversation
      match /replyDrafts/{draftId} {
        allow read, write: if ownsParentConversation(conversationId);
      }
    }

    // =========================================================================
    // Playbook (standalone, user-owned)
    // =========================================================================
    
    match /playbookEntries/{entryId} {
      allow create: if isCreatingOwned();
      allow read, update, delete: if isCurrentUser();
    }

    // =========================================================================
    // People (standalone, user-owned) + Entries (sub-collection)
    // =========================================================================

    match /people/{personId} {
      allow create: if isCreatingOwned();
      allow read, update, delete: if isCurrentUser();

      // Entries inherit from person ownership
      match /entries/{entryId} {
        allow read, write: if isSignedIn() &&
          get(/databases/$(database)/documents/people/$(personId)).data.uid == request.auth.uid;
      }
    }

    // =========================================================================
    // Deny everything else by default
    // =========================================================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
